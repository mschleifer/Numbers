<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Numbers</title>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.3/jquery.mobile.min.css" />
    <link rel="stylesheet" type="text/css" href="Numbers.css">
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.1.3.min.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.3/jquery.mobile.min.js"></script>
</head>
<body>
    <div class="GoalWidgetContainer">
        <span class="InlineBlock">
            F:
            <input id="txtGoalF" type="number" min="0" />
        </span>
        <span class="InlineBlock">
            C:
            <input id="txtGoalC" type="number" min="0" />
        </span>
        <span class="InlineBlock">
            P:
            <input id="txtGoalP" type="number" min="0" />
        </span>
        <span id="spnGoalRatio"></span>
    </div>
    <br />
    <div class="ChartWidgetContainer">
        <canvas id="canBarChart">Your browser does not support the HTML5 canvas tag.</canvas>
        <br />
        <input id="btnFAdd" type="button" class="AddButton" value="+" />
        <input id="btnFSub" type="button" class="SubButton" value="-" />
        <input id="btnCAdd" type="button" class="AddButton" value="+" />
        <input id="btnCSub" type="button" class="SubButton" value="-" />
        <input id="btnPAdd" type="button" class="AddButton" value="+" />
        <input id="btnPSub" type="button" class="SubButton" value="-" />
        <div class="Clear"></div>
        <div class="ButtonLabel">F <input type="number" id="txtFTotal" class="MacroTotalTextInput" data-role="none" /></div>
        <div class="ButtonLabel">C <input type="number" id="txtCTotal" class="MacroTotalTextInput" data-role="none" /></div>
        <div class="ButtonLabel">P <input type="number" id="txtPTotal" class="MacroTotalTextInput" data-role="none" /></div>
    </div>
    <div class="TotalWidgetContainer">
        <canvas id="canTotalChart"></canvas>
        <br />
        <button id="btnClearTotals">Clear All</button>
    </div>
    <div class="Clear"></div>
    <div class="TaskWidgetContainer">
        <input type="button" id="btnAddTask" value="Add Task" />
    </div>

</body>
</html>
<script>
    // Local Storage Locations
    var slFCount = "test.site.fCount";
    var slCCount = "test.site.cCount";
    var slPCount = "test.site.pCount";
    var slFGoal = "test.site.fGoal";
    var slCGoal = "test.site.cGoal";
    var slPGoal = "test.site.pGoal";
    var slTasks = "test.site.Tasks"

    // Setup the canvas
    var barChartCanvas = document.getElementById("canBarChart");
    var totalChartCanvas = document.getElementById("canTotalChart");
    var canvasHeight = 300;

    totalChartCanvas.height = canvasHeight;
    totalChartCanvas.width = 100;

    var barWidth;
    var barTextPadding;
    var barHorizontalPadding;
    var fBarXPosition;
    var fBarColor = "#000080";
    var cBarXPosition;
    var cBarColor = "#000000";
    var pBarXPosition;
    var pBarColor = "#800000";
    var fCount = localStorage.getItem(slFCount) || 0;
    var cCount = localStorage.getItem(slCCount) || 0;
    var pCount = localStorage.getItem(slPCount) || 0;
    var calCount = (fCount * 9) + (cCount * 4) + (pCount * 4);
    var fGoal = localStorage.getItem(slFGoal) || 80;
    var cGoal = localStorage.getItem(slCGoal) || 160;
    var pGoal = localStorage.getItem(slPGoal) || 160;
    var calGoal = (fGoal * 9) + (cGoal * 4) + (pGoal * 4);
    var buttonHoldTimer;

    var ctxBarChartCanvas = barChartCanvas.getContext("2d");
    ctxBarChartCanvas.textAlign = "center";
    ctxBarChartCanvas.font = "12px Arial";

    var ctxTotalChartCanvas = totalChartCanvas.getContext("2d");

    $(document).ready(function () {

        if (typeof (Storage) === "undefined") {
            alert("Your browser does not support HTML Local Storage. This application may not work correctly and anything you enter will not be saved after this browser tab is closed.");
        }

        resizeBarChart();
        redrawTotalChart();
        updateRatio();

        $(".AddButton").parent().css("margin-left", "2.5%")

        assignIncrementButtonClickListeners();

        $(window).resize(resizeBarChart);
        $(window).on('orientationchange', resizeBarChart);

        $("#txtGoalF").val(fGoal);
        $("#txtGoalC").val(cGoal);
        $("#txtGoalP").val(pGoal);

        $("#txtGoalF").change(updateGoals);
        $("#txtGoalC").change(updateGoals);
        $("#txtGoalP").change(updateGoals);

        $("#txtFTotal").val(fCount);
        $("#txtCTotal").val(cCount);
        $("#txtPTotal").val(pCount);

        $("#txtFTotal").change(updateTotals);
        $("#txtCTotal").change(updateTotals);
        $("#txtPTotal").change(updateTotals);

        $("#btnClearTotals").on("vclick", function () {
            fCount = 0;
            cCount = 0;
            pCount = 0;
            resizeBarChart();
            redrawTotalChart();
            saveAllCounts();
        });

        $("#btnAddTask").on("vclick", addTask);

    });

    function updateTotals() {
        if ($.isNumeric(this.value)) {
            fCount = $("#txtFTotal").val();
            cCount = $("#txtCTotal").val();
            pCount = $("#txtPTotal").val();

            redrawBarChart();
            redrawTotalChart();
        }
    }

    function resizeBarChart() {
        barChartCanvas.width = barChartCanvas.parentElement.clientWidth;
        barChartCanvas.height = canvasHeight;

        barWidth = barChartCanvas.width * .3;
        barTextPadding = 5;
        barHorizontalPadding = (barChartCanvas.width * .1) / 4
        fBarXPosition = barHorizontalPadding;
        cBarXPosition = fBarXPosition + barWidth + barHorizontalPadding;
        pBarXPosition = cBarXPosition + barWidth + barHorizontalPadding;

        redrawBarChart();
    }

    function redrawBarChart() {
        ctxBarChartCanvas.clearRect(0, 0, canBarChart.width, canBarChart.height);

        var unitHeight = (canvasHeight - barTextPadding - 10) / (Math.max(fCount, fGoal, pCount, pGoal, cCount, cGoal));

        // Fbar
        ctxBarChartCanvas.fillStyle = fBarColor;
        ctxBarChartCanvas.fillRect(fBarXPosition, canvasHeight, barWidth, -(fCount * unitHeight));
        //ctxBarChartCanvas.fillText(fCount, fBarXPosition + (barWidth / 2), canvasHeight - (fCount * unitHeight) - barTextPadding);
        $("#txtFTotal").val(fCount);

        if (parseInt(fCount) > parseInt(fGoal)) {
            ctxBarChartCanvas.strokeStyle = "#FFFFFF";
            ctxBarChartCanvas.fillStyle = "#FFFFFF";
            ctxBarChartCanvas.fillText(fGoal, fBarXPosition + (barWidth / 2), canvasHeight - (fGoal * unitHeight) + barTextPadding * 2);
        }
        else {
            ctxBarChartCanvas.strokeStyle = fBarColor;
            ctxBarChartCanvas.fillText(fGoal, fBarXPosition + (barWidth / 2), canvasHeight - (fGoal * unitHeight) - barTextPadding);
        }
        ctxBarChartCanvas.setLineDash([5]);
        ctxBarChartCanvas.beginPath();
        ctxBarChartCanvas.moveTo(fBarXPosition, canvasHeight - (fGoal * unitHeight));
        ctxBarChartCanvas.lineTo(fBarXPosition + barWidth, canvasHeight - (fGoal * unitHeight));
        ctxBarChartCanvas.stroke();

        // Cbar
        ctxBarChartCanvas.fillStyle = cBarColor;
        ctxBarChartCanvas.fillRect(cBarXPosition, canvasHeight, barWidth, -(cCount * unitHeight));
        //ctxBarChartCanvas.fillText(cCount, cBarXPosition + (barWidth / 2), canvasHeight - (cCount * unitHeight) - barTextPadding);
        $("#txtCTotal").val(cCount);

        if (parseInt(cCount) > parseInt(cGoal)) {
            ctxBarChartCanvas.strokeStyle = "#FFFFFF";
            ctxBarChartCanvas.fillStyle = "#FFFFFF";
            ctxBarChartCanvas.fillText(cGoal, cBarXPosition + (barWidth / 2), canvasHeight - (cGoal * unitHeight) + barTextPadding * 2);
        }
        else {
            ctxBarChartCanvas.strokeStyle = cBarColor;
            ctxBarChartCanvas.fillText(cGoal, cBarXPosition + (barWidth / 2), canvasHeight - (cGoal * unitHeight) - barTextPadding);
        }
        ctxBarChartCanvas.setLineDash([5]);
        ctxBarChartCanvas.beginPath();
        ctxBarChartCanvas.moveTo(cBarXPosition, canvasHeight - (cGoal * unitHeight));
        ctxBarChartCanvas.lineTo(cBarXPosition + barWidth, canvasHeight - (cGoal * unitHeight));
        ctxBarChartCanvas.stroke();

        // Pbar
        ctxBarChartCanvas.fillStyle = pBarColor;
        ctxBarChartCanvas.fillRect(pBarXPosition, canvasHeight, barWidth, -(pCount * unitHeight));
        //ctxBarChartCanvas.fillText(pCount, pBarXPosition + (barWidth / 2), canvasHeight - (pCount * unitHeight) - barTextPadding);
        $("#txtPTotal").val(pCount);

        if (parseInt(pCount) > parseInt(pGoal)) {
            ctxBarChartCanvas.strokeStyle = "#FFFFFF";
            ctxBarChartCanvas.fillStyle = "#FFFFFF";
            ctxBarChartCanvas.fillText(pGoal, pBarXPosition + (barWidth / 2), canvasHeight - (pGoal * unitHeight) + barTextPadding * 2);
        }
        else {
            ctxBarChartCanvas.strokeStyle = pBarColor;
            ctxBarChartCanvas.fillText(pGoal, pBarXPosition + (barWidth / 2), canvasHeight - (pGoal * unitHeight) - barTextPadding);
        }
        ctxBarChartCanvas.setLineDash([5]);
        ctxBarChartCanvas.beginPath();
        ctxBarChartCanvas.moveTo(pBarXPosition, canvasHeight - (pGoal * unitHeight));
        ctxBarChartCanvas.lineTo(pBarXPosition + barWidth, canvasHeight - (pGoal * unitHeight));
        ctxBarChartCanvas.stroke();
    }

    function redrawTotalChart() {
        calCount = (fCount * 9) + (cCount * 4) + (pCount * 4);
        ctxTotalChartCanvas.clearRect(0, 0, totalChartCanvas.width, totalChartCanvas.height)
        ctxTotalChartCanvas.strokeRect(0, 0, 50, canvasHeight);
        ctxTotalChartCanvas.fillRect(0, canvasHeight, 50, -((canvasHeight / (calGoal + 200)) * calCount));
        ctxTotalChartCanvas.fillText(calCount, 55, canvasHeight - ((canvasHeight / (calGoal + 200)) * calCount));
        ctxTotalChartCanvas.fillText(calGoal, 55, canvasHeight - ((canvasHeight / (calGoal + 200)) * calGoal))
    }

    function assignIncrementButtonClickListeners() {
        $("#btnFAdd").on("vmousedown", function () {
            fCount++;
            redrawBarChart();
            redrawTotalChart();
            saveFCount();

            buttonHoldTimer = setInterval(function () {
                fCount++;
                redrawBarChart();
                redrawTotalChart();
            }, 150);
            return false;
        });

        $("#btnFSub").on("vmousedown", function () {
            if (fCount > 0) {
                fCount--;
                redrawBarChart();
                redrawTotalChart();
                saveFCount();

                buttonHoldTimer = setInterval(function () {
                    if (fCount > 0) {
                        fCount--;
                        redrawBarChart();
                        redrawTotalChart();
                    }
                }, 150);
            }
            return false;
        });

        $("#btnCAdd").on("vmousedown", function () {
            cCount++;
            redrawBarChart();
            redrawTotalChart();
            saveCCount();

            buttonHoldTimer = setInterval(function () {
                cCount++;
                redrawBarChart();
                redrawTotalChart();
            }, 150);
            return false;
        });

        $("#btnCSub").on("vmousedown", function () {
            if (cCount > 0) {
                cCount--;
                redrawBarChart();
                redrawTotalChart();
                saveCCount();

                buttonHoldTimer = setInterval(function () {
                    if (cCount > 0) {
                        cCount--;
                        redrawBarChart();
                        redrawTotalChart();
                    }
                }, 150);
            }
            return false;
        });

        $("#btnPAdd").on("vmousedown", function () {
            pCount++;
            redrawBarChart();
            redrawTotalChart();
            savePCount();

            buttonHoldTimer = setInterval(function () {
                pCount++;
                redrawBarChart();
                redrawTotalChart();
            }, 150);
            return false;
        });

        $("#btnPSub").on("vmousedown", function () {
            if (pCount > 0) {
                pCount--;
                redrawBarChart();
                redrawTotalChart();
                savePCount();

                buttonHoldTimer = setInterval(function () {
                    if (pCount > 0) {
                        pCount--;
                        redrawBarChart();
                        redrawTotalChart();
                    }
                }, 150);
            }
            return false;
        });

        $(document).on("vmouseup touchend", function () {
            clearInterval(buttonHoldTimer);
            saveFCount();
            saveCCount();
            savePCount();
            return false;
        });
    }

    function updateGoals() {
        if ($.isNumeric(this.value)) {
            fGoal = $("#txtGoalF").val();
            cGoal = $("#txtGoalC").val();
            pGoal = $("#txtGoalP").val();
            localStorage.setItem(slFGoal, fGoal);
            localStorage.setItem(slCGoal, cGoal);
            localStorage.setItem(slPGoal, pGoal);

            calGoal = (fGoal * 9) + (cGoal * 4) + (pGoal * 4);
            updateRatio();
            redrawBarChart();
            redrawTotalChart();
        }
        return false;
    }

    function updateRatio() {
        var goalTotal = Number(fGoal) + Number(cGoal) + Number(pGoal);
        $("#spnGoalRatio").text((100 * fGoal / goalTotal).toFixed(2) + ":" + (100 * cGoal / goalTotal).toFixed(2) + ":" + (100 * pGoal / goalTotal).toFixed(2));
    }

    function addTask() {
        $(".TaskWidgetContainer").append("<div class='TaskItem'><br /><input type='checkbox' class='TaskCheckbox' /><span class='NewTaskText' contenteditable='true'>Add Task...</span><input type='button' class='DeleteTaskButton' value='X' /></div>");
        $(".TaskCheckbox").change(toggleTaskText);
        $(".DeleteTaskButton").on("vclick", deleteTask);
        $(".NewTaskText").focus();
        $(".NewTaskText").one("keydown", function () {
            $(".NewTaskText").empty();
        });
        $(".NewTaskText").one("blur", function () {
            if ($(".NewTaskText").text() == "" || $(".NewTaskText").text() == "Add Task...") {
                $(".TaskWidgetContainer div").last().remove();
            }
            $(".NewTaskText").toggleClass("NewTaskText TaskText");
        });
    }

    function deleteTask() {
        $(this).parent().remove();
    }

    function toggleTaskText() {
        $(".TaskCheckbox").change($(this).next("span").toggleClass("StrikeText"));
    }

    function saveAllCounts() {
        saveFCount();
        saveCCount();
        savePCount();
    }
    function saveFCount() {
        localStorage.setItem(slFCount, fCount)
    }
    function saveCCount() {
        localStorage.setItem(slCCount, cCount)
    }
    function savePCount() {
        localStorage.setItem(slPCount, pCount)
    }

</script>
